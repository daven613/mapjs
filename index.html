<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Torah Map - Fixed</title>

    <!-- CSS -->
    <link rel="stylesheet" href="./css/styles.css">

    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <!-- Sigma.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js"></script>

    <!-- Working Sigma.js plugins -->
    <script src="https://cdn.jsdelivr.net/gh/jacomyal/sigma.js@v1.2.1/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jacomyal/sigma.js@v1.2.1/plugins/sigma.layout.forceAtlas2/worker.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jacomyal/sigma.js@v1.2.1/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>

    <!-- Data -->
    <script src="./data/torah2.js"></script>

    <!-- Helper Scripts -->
    <script src="./js/hello-sigma.js"></script>
</head>
<body>
    <!-- Query Interface -->
    <div id="div_toggle_cypher_query"><button type="button" onclick="$('#div_cypher_query').toggle()">X</button></div>
    <div id="div_cypher_query" class="alpha60">
        <div style="display: flex">
            <select id="select_query_type" onchange="changeQueryType(this.value)">
                <option value="advice" selected>Get Advice</option>
                <option value="effects">Get Effects</option>
                <option value="by_torah">Search By Torah</option>
                <option value="bechinos">Get Bechinos</option>
                <option value="connected">Get All Connected Topics</option>
            </select>
            <button type="button" id="button_hebrew" onclick="toHebrew()">עברית</button>
            <button type="button" id="button_english" onclick="toEnglish()" style="display:none">English</button>
        </div>
        <hr>
        <div id="div_select_topic_advice"><b>Select Topic:</b> <input id="input_topic_advice"></div>
        <div id="div_select_topic_effects" style="display:none"><b>Select Topic:</b> <input id="input_topic_effects"></div>
        <div id="div_select_topic_bechinos" style="display:none"><b>Select Topic:</b> <input id="input_topic_bechinos"></div>
        <div id="div_select_topic_1" style="display:none"><b>Select Topic:</b> <input id="input_topic_1"></div>
        <div id="div_select_torah" style="display:none"><b>Select Torah #:</b> <select id="select_torah"></select></div>
        <div style="padding: 10px 0px;"><button type="button" onclick="runQuery()">Run Search</button></div>
    </div>

    <!-- Connection Info Display -->
    <div id="div_connection_info" class="alpha60" style="display:none;direction:rtl;">
        <table>
            <tr><th>מנושא</th><td><p id="txt_from_node"></p></td></tr>
            <tr><th>לנושא</th><td><p id="txt_to_node"></p></td></tr>
            <tr><th>ראיה</th><td><p id="txt_proof"></p></td></tr>
            <tr><th>מקור</th><td><p id="txt_reference"></p></td></tr>
        </table>
    </div>

    <!-- Status -->
    <div id="div_status" class="alpha60" style="display:none"></div>

    <!-- Graph Container -->
    <div id="graph-container"></div>

    <script>
var init_sigma;
var allTopics = [];

// Initialize on document ready
$(document).ready(function() {
    console.log('Initializing...');

    // Check if data loaded
    if (typeof torah1 === 'undefined') {
        alert('Torah data not loaded!');
        return;
    }
    console.log('Torah data loaded:', torah1.length, 'entries');

    // Extract topics for autocomplete
    var topicSet = new Set();
    var torahSet = new Set();

    torah1.forEach(function(item) {
        if (item.node1_id) topicSet.add(item.node1_id);
        if (item.node2_id) topicSet.add(item.node2_id);
        if (item.reference) torahSet.add(item.reference);
    });

    allTopics = Array.from(topicSet).sort();
    console.log('Found', allTopics.length, 'unique topics');

    // Setup autocomplete
    $("#input_topic_advice, #input_topic_effects, #input_topic_bechinos, #input_topic_1").autocomplete({
        source: allTopics,
        minLength: 2
    });

    // Populate Torah dropdown
    var torahNums = Array.from(torahSet).sort((a,b) => a-b);
    torahNums.forEach(function(num) {
        $('#select_torah').append('<option value="' + num + '">' + num + '</option>');
    });

    // Initialize Sigma
    initSigma();

    console.log('Ready!');
});

function initSigma() {
    try {
        // Initialize with CANVAS renderer to fix edge click issues
        init_sigma = new sigma({
            renderer: {
                container: document.getElementById('graph-container'),
                type: 'canvas'  // CRITICAL: Use canvas, not webgl
            }
        });

        // Configure settings
        init_sigma.settings({
            minNodeSize: 1,
            maxNodeSize: 10,
            minEdgeSize: 0.5,
            maxEdgeSize: 2,
            enableEdgeHovering: true,
            edgeHoverSizeRatio: 2,
            defaultNodeColor: '#6cbef4',
            defaultEdgeColor: '#999',
            labelThreshold: 4,
            labelSize: 'fixed',
            defaultLabelSize: 13
        });

        // Enable drag nodes
        var dragListener = sigma.plugins.dragNodes(init_sigma, init_sigma.renderers[0]);

        // Bind edge click
        init_sigma.bind('clickEdge', function(e) {
            var edge = e.data.edge;
            $('#txt_from_node').text(edge.node1_text || '');
            $('#txt_to_node').text(edge.node2_text || '');
            $('#txt_proof').text(edge.proof || '');
            $('#txt_reference').text(edge.reference || '');
            $('#div_connection_info').show();
        });

        // Hide info on stage click
        init_sigma.bind('clickStage', function(e) {
            $('#div_connection_info').hide();
        });

        console.log('Sigma initialized successfully');
    } catch(e) {
        console.error('Failed to init sigma:', e);
    }
}

function changeQueryType(type) {
    // Hide all input divs
    $('#div_cypher_query > div').hide();
    $('#div_cypher_query > div:first').show(); // Keep dropdown visible
    $('hr').show();

    // Show relevant input
    switch(type) {
        case 'advice':
            $('#div_select_topic_advice').show();
            break;
        case 'effects':
            $('#div_select_topic_effects').show();
            break;
        case 'by_torah':
            $('#div_select_torah').show();
            break;
        case 'bechinos':
            $('#div_select_topic_bechinos').show();
            break;
        case 'connected':
            $('#div_select_topic_1').show();
            break;
    }
    $('div:has(button[onclick="runQuery()"])').show();
}

function runQuery() {
    if (!init_sigma) {
        alert('Graph not initialized');
        return;
    }

    showStatus('Searching...');
    init_sigma.graph.clear();

    var queryType = $('#select_query_type').val();
    var results = [];

    switch(queryType) {
        case 'advice':
            var topic = $('#input_topic_advice').val();
            if (!topic) {
                showStatus('Please enter a topic');
                return;
            }
            results = torah1.filter(item =>
                item.type === 'eitza' && item.node2_id && item.node2_id.includes(topic)
            );
            break;

        case 'effects':
            var topic = $('#input_topic_effects').val();
            if (!topic) {
                showStatus('Please enter a topic');
                return;
            }
            results = torah1.filter(item =>
                item.type === 'eitza' && item.node1_id && item.node1_id.includes(topic)
            );
            break;

        case 'by_torah':
            var torahNum = parseInt($('#select_torah').val());
            results = torah1.filter(item => item.reference === torahNum);
            break;

        case 'bechinos':
            var topic = $('#input_topic_bechinos').val();
            if (!topic) {
                showStatus('Please enter a topic');
                return;
            }
            results = torah1.filter(item =>
                item.type === 'bechina' &&
                ((item.node1_id && item.node1_id.includes(topic)) ||
                 (item.node2_id && item.node2_id.includes(topic)))
            );
            break;

        case 'connected':
            var topic = $('#input_topic_1').val();
            if (!topic) {
                showStatus('Please enter a topic');
                return;
            }
            results = torah1.filter(item =>
                (item.node1_id && item.node1_id.includes(topic)) ||
                (item.node2_id && item.node2_id.includes(topic))
            );
            break;
    }

    console.log('Query returned', results.length, 'results');

    if (results.length === 0) {
        showStatus('No results found');
        setTimeout(() => $('#div_status').hide(), 2000);
        return;
    }

    // Build graph
    buildGraph(results.slice(0, 150));
}

function buildGraph(edges) {
    var nodes = {};

    // Build nodes from edges
    edges.forEach(function(edge, idx) {
        if (edge.node1_id && !nodes[edge.node1_id]) {
            nodes[edge.node1_id] = {
                id: edge.node1_id,
                label: edge.node1_text || edge.node1_id,
                x: Math.random() * 100,
                y: Math.random() * 100,
                size: 3,
                color: '#6cbef4'
            };
        }

        if (edge.node2_id && !nodes[edge.node2_id]) {
            nodes[edge.node2_id] = {
                id: edge.node2_id,
                label: edge.node2_text || edge.node2_id,
                x: Math.random() * 100,
                y: Math.random() * 100,
                size: 3,
                color: '#6cbef4'
            };
        }
    });

    // Add nodes to graph
    Object.values(nodes).forEach(node => {
        init_sigma.graph.addNode(node);
    });

    // Add edges with all properties
    edges.forEach(function(edge, idx) {
        if (edge.node1_id && edge.node2_id) {
            try {
                init_sigma.graph.addEdge({
                    id: 'e' + idx,
                    source: edge.node1_id,
                    target: edge.node2_id,
                    // Store all data for click handler
                    node1_text: edge.node1_text,
                    node2_text: edge.node2_text,
                    proof: edge.proof,
                    reference: edge.reference,
                    color: edge.type === 'eitza' ? '#cf4ac8' : '#999',
                    size: 1
                });
            } catch(e) {
                // Skip duplicate edges
            }
        }
    });

    // Refresh display
    init_sigma.refresh();

    // Apply force layout if available
    if (init_sigma.startForceAtlas2) {
        init_sigma.startForceAtlas2({
            worker: false,
            barnesHutOptimize: false,
            gravity: 1,
            scalingRatio: 10
        });

        setTimeout(function() {
            init_sigma.stopForceAtlas2();
        }, 2000);
    }

    showStatus('Found ' + Object.keys(nodes).length + ' nodes, ' + edges.length + ' connections');
    setTimeout(() => $('#div_status').hide(), 3000);
}

function showStatus(msg) {
    $('#div_status').text(msg).show();
    var elem = document.getElementById('div_status');
    if (elem) {
        elem.style.top = 'calc(50% - ' + (elem.offsetHeight/2) + 'px)';
        elem.style.left = 'calc(50% - ' + (elem.offsetWidth/2) + 'px)';
    }
}

function toHebrew() {
    $('#div_cypher_query').css('direction', 'rtl');
    $('button[onclick="runQuery()"]').text('חפש');
    $('#select_query_type option[value="advice"]').text('קבל עצה');
    $('#select_query_type option[value="effects"]').text('קבל נמשך');
    $('#select_query_type option[value="by_torah"]').text('חפש לפי תורה');
    $('#select_query_type option[value="bechinos"]').text('בחינות');
    $('#select_query_type option[value="connected"]').text('כל הקשורים');
    $('#button_english').show();
    $('#button_hebrew').hide();
}

function toEnglish() {
    $('#div_cypher_query').css('direction', 'ltr');
    $('button[onclick="runQuery()"]').text('Run Search');
    $('#select_query_type option[value="advice"]').text('Get Advice');
    $('#select_query_type option[value="effects"]').text('Get Effects');
    $('#select_query_type option[value="by_torah"]').text('Search By Torah');
    $('#select_query_type option[value="bechinos"]').text('Get Bechinos');
    $('#select_query_type option[value="connected"]').text('Get All Connected');
    $('#button_hebrew').show();
    $('#button_english').hide();
}
    </script>
</body>
</html>